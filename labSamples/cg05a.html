<!DOCTYPE html>
<html>

<head>
    <title>Kage Bunshin no Jutsu (影分身の術)</title>
    <meta charset="UTF-8">
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <script src="/js/three.js"></script>
    <script src="/js/loaders/GLTFLoader.js"></script>
    <script src="/js/controls/TrackballControls.js"></script>

    <script>
        var scene = new THREE.Scene();
        scene.background = new THREE.Color(0x7ec0ee);

        var aspect = window.innerWidth / window.innerHeight;
        var camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 1000);
        controls = new THREE.TrackballControls(camera);

        var renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // MORE Javascript will go here.
        var shaderLoader = new THREE.FileLoader();

        var vShader = shaderLoader.load('cg05_vertex.glsl');
        var fShader = shaderLoader.load('cg05_fragment.glsl');

        var naruto;

        async function loadModels() {

            var loader = new THREE.GLTFLoader();

            loader.load('models/naruto_basic/scene.gltf', function (gltf) {

                scene.add(gltf.scene);

                // gltf.scene.traverse(function (child) {
                //     if (child instanceof THREE.Mesh) {

                //         child.material = new THREE.ShaderMaterial({
                //             vertexShader: vShader.responseText,
                //             fragmentShader: fShader.responseText
                //         });

                //     }
                // });

                gltf.scene.traverse(function (child) {
                    if (child instanceof THREE.Mesh) {

                        child.material = new THREE.ShaderMaterial({
                            uniforms: {
                                lightSrc: { type: "v3", value: directionalLight.position },
                                texture: { type: "t", value: child.material.map }
                            },
                            vertexShader: vShader.responseText,
                            fragmentShader: fShader.responseText
                        });
                        child.castShadow = true;
                    }
                });

                naruto = gltf.scene;

            }, undefined, function (error) {

                console.error(error);

            });

        }

        loadModels();

        var directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(200, 200, 200);
        scene.add(directionalLight);

        directionalLight.castShadow = true;

        directionalLight.shadow.camera.near = 0.5;       // default
        directionalLight.shadow.camera.far = 500;      
        directionalLight.shadow.camera.left = -512;    
        directionalLight.shadow.camera.right = 512;    
        directionalLight.shadow.camera.top = -512;     
        directionalLight.shadow.camera.bottom = 512;   

        var helper = new THREE.CameraHelper(directionalLight.shadow.camera);
        scene.add(helper);
        
        function func(u, v, target) {

        var x = (u - 0.5) * 2000;
        var y = (v - 0.5) * 2000;
        var z = Math.cos(10 * u) * Math.cos(10 * v) * 100;

        target.set(x, y, z);

        }

        var geometry = new THREE.ParametricGeometry( func, 32, 32 );
        var material = new THREE.MeshLambertMaterial({color: 0x6B5A38});

        var plane = new THREE.Mesh(geometry, material);
        plane.position.set(0, -100, 0);
        plane.rotation.set(-Math.PI / 2, 0, 0);

        plane.receiveShadow = true;

        scene.add(plane);

        var mouse = new THREE.Vector2();

        function onDocumentMouseClick(event) {

            event.preventDefault();

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;

            raycaster = new THREE.Raycaster();

            var vector = new THREE.Vector3(mouse.x, mouse.y, 1).unproject(camera);

            raycaster.set(camera.position, vector.sub(camera.position).normalize());

            var intersects = raycaster.intersectObjects(scene.children);
            if (intersects.length > 0) {

            var narutoClone = naruto.clone();

            narutoClone.position.x = intersects[0].point.x;
            narutoClone.position.y = intersects[0].point.y + 50;
            narutoClone.position.z = intersects[0].point.z;

            narutoClone.rotation.y = (Math.random() - 0.5);

            scene.add(narutoClone);
            }
        }

        document.addEventListener('click', onDocumentMouseClick, false);

        camera.position.z = 500;

        var render = function () {
            requestAnimationFrame(render);
            renderer.shadowMap.enabled = true;
            controls.update();
            renderer.render(scene, camera);
        };

        render();

    </script>

</body>

</html>